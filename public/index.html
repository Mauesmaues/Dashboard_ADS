<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Conceito Prime</title>
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/auth.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
</head>
<body>    <div class="container-fluid">
        <header class="bg-primary text-white p-4 mb-4" style="background: linear-gradient(135deg, #3498db, #1abc9c) !important;">
            <div class="container">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-1 fw-bold"><i class="fas fa-chart-line me-2"></i>BI Conceito Prime</h1>
                        <p class="mb-0 opacity-75">Sistema de Business Intelligence Direcionado a Campanhas META ADS</p>
                    </div>
                    <div>
                        <nav class="navbar navbar-expand navbar-dark">
                            <ul class="navbar-nav ms-auto">
                                <!-- User info and logout button will be added here by auth.js -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container main-content">            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Data Inicial:</label>
                            <input type="text" class="form-control date-picker" id="startDate" placeholder="DD/MM/YYYY">
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">Data Final:</label>
                            <input type="text" class="form-control date-picker" id="endDate" placeholder="DD/MM/YYYY">
                        </div>
                        <div class="col-md-4">                            <label for="company-select" class="form-label">Empresa:</label>
                            <select class="form-select" id="company-select">
                                <option value="">Todas as Empresas</option>
                                <!-- Companies will be loaded dynamically based on user access -->
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-8">
                                <label class="form-label">Filtros rápidos:</label>
                                <div>
                                    <button id="todayBtn" class="btn btn-filter" data-preset="today"><i class="fas fa-calendar-day me-1"></i>Hoje</button>
                                    <button id="yesterdayBtn" class="btn btn-filter" data-preset="yesterday"><i class="fas fa-calendar-minus me-1"></i>Ontem</button>
                                    <button id="thisWeekBtn" class="btn btn-filter" data-preset="thisWeek"><i class="fas fa-calendar-week me-1"></i>Esta Semana</button>
                                    <button id="thisMonthBtn" class="btn btn-filter" data-preset="thisMonth"><i class="fas fa-calendar-alt me-1"></i>Este Mês</button>
                                    <button id="lastMonthBtn" class="btn btn-filter" data-preset="lastMonth"><i class="fas fa-calendar-check me-1"></i>Mês Anterior</button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end d-flex align-items-end justify-content-end">
                                <button id="applyFilters" class="btn btn-primary"><i class="fas fa-search me-1"></i>Aplicar Filtros</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Nova div mb-5 -->
            <div class="mb-5">
                <!-- Conteúdo da nova div pode ser adicionado aqui -->
            </div>
            
            <!-- Indicador de carregamento global -->
            <div id="loading" class="text-center my-3 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Carregando dados...</p>
            </div>
            
            <!-- Tabs para selecionar visualização -->            <div class="mb-4">
                <ul class="nav nav-tabs" id="viewTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="company-tab" data-bs-toggle="tab" data-bs-target="#company-view" type="button" role="tab" aria-controls="company-view" aria-selected="true">
                            <i class="fas fa-ad me-2"></i>Campanhas por Conta
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="video-engagement-tab" data-bs-toggle="tab" data-bs-target="#video-engagement-view" type="button" role="tab" aria-controls="video-engagement-view" aria-selected="false">
                            <i class="fas fa-play me-2"></i>Engajamento Vídeo
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="mb-5"></div>
            
            <!-- Tab Content -->
            <div class="tab-content" id="viewTabsContent">
                <!-- Tabela de Dados por Empresa -->
                <div class="tab-pane fade show active" id="company-view" role="tabpanel" aria-labelledby="company-tab">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Métricas por Empresa</h5>
                            <div class="actions">
                                <button id="exportCompanyBtn" class="btn btn-sm btn-success">Exportar Excel</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="loading-company" class="spinner-border text-primary d-none" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="companyMetricsTable">
                                    <thead>                                        <tr>
                                            <th>Empresa</th>
                                            <th>Total de Cliques</th>
                                            <th>Gasto Total</th>
                                            <th data-bs-toggle="tooltip" title="Gasto ÷ Total de Cliques">CPC Médio</th>
                                            <th data-bs-toggle="tooltip" title="Impressões Totais">Impressões</th>
                                            <th data-bs-toggle="tooltip" title="Taxa de Cliques"><i class="fas fa-percentage me-1"></i>CTR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="companyTableBody">
                                        <!-- Company data will be loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noCompanyData" class="alert alert-info text-center d-none">
                                Nenhum dado encontrado para os filtros selecionados.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Aba de Engajamento de Vídeo -->
                <div class="tab-pane fade" id="video-engagement-view" role="tabpanel" aria-labelledby="video-engagement-tab">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-play me-2"></i>Métricas de Engajamento de Vídeo</h5>
                            <div class="actions">
                                <button id="exportVideoBtn" class="btn btn-sm btn-success">
                                    <i class="fas fa-file-excel me-1"></i>Exportar Excel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="loading-video" class="spinner-border text-primary d-none" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            
                            <!-- Gráficos de Engajamento de Vídeo -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-play me-1"></i>Reproduções de Vídeo</h6>
                                        <canvas id="videoPlaysChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-clock me-1"></i>Tempo Médio Assistido</h6>
                                        <canvas id="videoAvgTimeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-stopwatch me-1"></i>Vídeos Assistidos por 10s</h6>
                                        <canvas id="video10SecChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-hourglass-half me-1"></i>Vídeos Assistidos por 30s</h6>
                                        <canvas id="video30SecChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="noVideoData" class="alert alert-info text-center d-none">
                                Nenhum dado de engajamento de vídeo encontrado para os filtros selecionados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
              <!-- Gráficos -->            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Visualização Gráfica</h5>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-primary chart-refresh">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Sub-abas para gráficos -->
                    <div class="mb-3">
                        <ul class="nav nav-pills" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="company-charts-tab" data-bs-toggle="pill" data-bs-target="#company-charts-content" type="button" role="tab" aria-controls="company-charts-content" aria-selected="true">
                                    <i class="fas fa-building me-1"></i>Por Conta
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="daily-charts-tab" data-bs-toggle="pill" data-bs-target="#daily-charts-content" type="button" role="tab" aria-controls="daily-charts-content" aria-selected="false">
                                    <i class="fas fa-calendar-alt me-1"></i>Por Dia
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Conteúdo das sub-abas -->
                    <div class="tab-content" id="chartTabsContent">
                        <!-- Gráficos por empresa -->
                        <div class="tab-pane fade show active" id="company-charts-content" role="tabpanel" aria-labelledby="company-charts-tab">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-building me-1"></i>Registros por Empresa</h6>
                                        <canvas id="companyRegistersChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-hand-holding-usd me-1"></i>CPL por Empresa</h6>
                                        <canvas id="companyCplChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gráficos por dia -->
                        <div class="tab-pane fade" id="daily-charts-content" role="tabpanel" aria-labelledby="daily-charts-tab">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-mouse-pointer me-1"></i>Cliques por Dia</h6>
                                        <canvas id="registersChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container p-3 bg-white rounded shadow-sm">
                                        <h6 class="text-muted mb-3"><i class="fas fa-dollar-sign me-1"></i>CPC e Gastos por Dia</h6>
                                        <canvas id="cplChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CRM - Funil de Vendas (visível apenas para empresa específica) -->
            <div class="card mb-4 d-none" id="crmSection">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>CRM - Funil de Vendas</h5>
                    <div class="actions">
                        <button id="addLeadBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>Adicionar Lead
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- CRM Kanban Board -->
                    <div class="row">
                        <!-- Coluna 1: Entrou! -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="entrou">
                                <div class="crm-column-header bg-info text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-arrow-down me-2"></i>Entrou!</h6>
                                    <small class="text-white-50">Novos leads</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão carregados automaticamente do banco de dados -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna 2: Agendou! -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="agendou">
                                <div class="crm-column-header bg-warning text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Agendou!</h6>
                                    <small class="text-white-50">Reunião marcada</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna 3: Analisando -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="analisando">
                                <div class="crm-column-header bg-primary text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>Analisando</h6>
                                    <small class="text-white-50">Em análise</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna 4: Fechou! -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="fechou">
                                <div class="crm-column-header bg-success text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-handshake me-2"></i>Fechou!</h6>
                                    <small class="text-white-50">Vendas concluídas</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" style="min-height: 400px;" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
      <footer class="p-4 mt-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-md-start text-center mb-3 mb-md-0">
                    <h5 class="mb-1"><i class="fas fa-chart-line me-2"></i>BI Conceito Prime Inbound</h5>
                    <p class="text-muted mb-0">Sistema de Business Intelligence Direcionado Meta Ads</p>
                </div>
                <div class="col-md-6 text-md-end text-center">
                    <p class="mb-0 text-muted">Conceito Prime LTDA© 2025 - Todos os direitos reservados</p>
                    <p class="mb-0 small text-muted">Versão BETA - Atualizado em 06/08/2025</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- CSS personalizado para CRM -->
    <style>
        .crm-column {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .crm-column:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }

        .crm-column-body {
            transition: background-color 0.3s ease;
            max-height: 80vh; /* Máximo de 80% da altura da tela */
            overflow-y: auto; /* Scroll vertical quando necessário */
            overflow-x: hidden; /* Ocultar scroll horizontal */
        }

        .crm-column-body.drag-over {
            background-color: #e3f2fd !important;
            border: 2px solid #2196f3;
        }

        /* Personalizar scrollbar para melhor aparência */
        .crm-column-body::-webkit-scrollbar {
            width: 6px;
        }

        .crm-column-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .crm-column-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .crm-column-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .crm-card {
            cursor: move;
            transition: all 0.3s ease;
        }

        .crm-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .crm-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .crm-column-header {
            position: relative;
            overflow: hidden;
        }

        .crm-column-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .crm-column:hover .crm-column-header::before {
            left: 100%;
        }

        .lead-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
        }

        .lead-data-section {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .lead-notes-section textarea {
            border: 1px dashed #dee2e6;
            resize: vertical;
            min-height: 50px;
        }

        .lead-notes-section textarea:focus {
            border-color: #007bff;
            border-style: solid;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        .crm-card .card-body {
            padding: 8px !important;
        }

        .lead-data-section .card-text {
            margin-bottom: 4px !important;
            line-height: 1.3;
        }

        /* Responsividade para telas menores */
        @media (max-width: 768px) {
            .crm-column-body {
                max-height: 70vh; /* Reduzir para telas menores */
            }
        }

        @media (max-width: 576px) {
            .crm-column-body {
                max-height: 60vh; /* Ainda menor para telas muito pequenas */
            }
        }
    </style>

    <!-- JavaScript para Drag and Drop do CRM -->
    <script>
        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.classList.add('dragging');
        }

        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            var draggedElement = document.getElementById(data);
            
            // Remove drag-over class from all columns
            document.querySelectorAll('.crm-column-body').forEach(col => {
                col.classList.remove('drag-over');
            });
            
            // Remove dragging class
            draggedElement.classList.remove('dragging');
            
            // Find the correct column body to append to
            var dropTarget = ev.target;
            while (dropTarget && !dropTarget.classList.contains('crm-column-body')) {
                dropTarget = dropTarget.parentNode;
            }
            
            if (dropTarget && dropTarget.classList.contains('crm-column-body')) {
                dropTarget.appendChild(draggedElement);
                
                // Update badge based on new stage
                var stage = dropTarget.parentNode.dataset.stage;
                var badge = draggedElement.querySelector('.badge');
                if (badge) {
                    badge.className = 'badge';
                    switch(stage) {
                        case 'entrou':
                            badge.classList.add('bg-info');
                            badge.textContent = 'Novo';
                            break;
                        case 'agendou':
                            badge.classList.add('bg-warning');
                            badge.textContent = 'Agendado';
                            break;
                        case 'analisando':
                            badge.classList.add('bg-primary');
                            badge.textContent = 'Analisando';
                            break;
                        case 'fechou':
                            badge.classList.add('bg-success');
                            badge.textContent = 'Fechado';
                            break;
                    }
                }
                
                // Show success toast
                if (typeof showToast === 'function') {
                    showToast('CRM', `Lead movido para ${stage}!`, 'success');
                }
            }
        }

        // Remove drag-over class when dragging leaves
        document.addEventListener('dragleave', function(ev) {
            if (ev.target.classList.contains('crm-column-body')) {
                ev.target.classList.remove('drag-over');
            }
        });

        // Add Lead functionality
        document.addEventListener('DOMContentLoaded', function() {
            const addLeadBtn = document.getElementById('addLeadBtn');
            if (addLeadBtn) {
                addLeadBtn.addEventListener('click', function() {
                    addNewLead();
                });
            }
        });

        function addNewLead() {
            const name = prompt('Nome do lead:');
            const email = prompt('Email do lead:');
            const phone = prompt('Telefone do lead:');
            
            if (name && email) {
                const leadId = 'lead' + Date.now();
                const leadCard = createLeadCard(leadId, name, email, phone);
                
                // Add to first column (Entrou!)
                const firstColumn = document.querySelector('[data-stage="entrou"] .crm-column-body');
                firstColumn.appendChild(leadCard);
                
                if (typeof showToast === 'function') {
                    showToast('CRM', `Lead ${name} adicionado com sucesso!`, 'success');
                }
            }
        }

        function createLeadCard(id, name, email, phone) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'crm-card';
            cardDiv.draggable = true;
            cardDiv.id = id;
            cardDiv.ondragstart = drag;
            
            cardDiv.innerHTML = `
                <div class="card shadow-sm mb-3">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2">${name}</h6>
                        <p class="card-text small text-muted mb-2">
                            <i class="fas fa-envelope me-1"></i>${email}
                        </p>
                        ${phone ? `<p class="card-text small text-muted mb-2">
                            <i class="fas fa-phone me-1"></i>${phone}
                        </p>` : ''}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>Hoje
                            </small>
                            <span class="badge bg-info">Novo</span>
                        </div>
                    </div>
                </div>
            `;
            
            return cardDiv;
        }

        // Função para criar card do CRM com dados do banco
        function createLeadCardFromDB(leadData) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'crm-card';
            cardDiv.draggable = true;
            cardDiv.id = `lead_${leadData.id}`;
            cardDiv.ondragstart = drag;
            
            // Formatar data (tratar como texto)
            let dataFormatada = 'Data não informada';
            let horaFormatada = '';
            
            if (leadData.data_hora_entrada) {
                try {
                    const dataEntrada = new Date(leadData.data_hora_entrada);
                    if (!isNaN(dataEntrada.getTime())) {
                        dataFormatada = dataEntrada.toLocaleDateString('pt-BR');
                        horaFormatada = dataEntrada.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    } else {
                        // Se não conseguir converter, usar o texto original
                        dataFormatada = leadData.data_hora_entrada;
                    }
                } catch (e) {
                    dataFormatada = leadData.data_hora_entrada;
                }
            }
            
            // Função para tratar valores booleanos em texto
            function tratarBooleano(valor) {
                if (!valor) return null;
                const valorLower = valor.toString().toLowerCase().trim();
                if (valorLower === 'true' || valorLower === 't' || valorLower === '1' || valorLower === 'sim' || valorLower === 'yes') {
                    return true;
                }
                if (valorLower === 'false' || valorLower === 'f' || valorLower === '0' || valorLower === 'não' || valorLower === 'nao' || valorLower === 'no') {
                    return false;
                }
                return null;
            }
            
            const jaRealizou = tratarBooleano(leadData.ja_realizou);
            
            cardDiv.innerHTML = `
                <div class="card shadow-sm mb-3">
                    <div class="card-body p-2">
                        <!-- Dados do Banco -->
                        <div class="lead-data-section border-bottom pb-2 mb-2">
                            <h6 class="card-title mb-1 text-primary">${leadData.nome || 'Nome não informado'}</h6>
                            ${leadData.email ? `<p class="card-text small text-muted mb-1">
                                <i class="fas fa-envelope me-1"></i>${leadData.email}
                            </p>` : ''}
                            ${leadData.telefone ? `<p class="card-text small text-muted mb-1">
                                <i class="fas fa-phone me-1"></i>${leadData.telefone}
                            </p>` : ''}
                            ${leadData.procedimento_interesse ? `<p class="card-text small text-muted mb-1">
                                <i class="fas fa-heart me-1"></i><strong>Interesse:</strong> ${leadData.procedimento_interesse}
                            </p>` : ''}
                            ${jaRealizou !== null ? `<p class="card-text small text-muted mb-1">
                                <i class="fas fa-check-circle me-1"></i><strong>Já realizou:</strong> ${jaRealizou ? 'Sim' : 'Não'}
                            </p>` : ''}
                            ${leadData.quando_pretende ? `<p class="card-text small text-muted mb-1">
                                <i class="fas fa-calendar-alt me-1"></i><strong>Quando pretende:</strong> ${leadData.quando_pretende}
                            </p>` : ''}
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>${dataFormatada}${horaFormatada ? ` às ${horaFormatada}` : ''}
                            </small>
                        </div>
                        
                        <!-- Seção de Observações -->
                        <div class="lead-notes-section">
                            <textarea class="form-control form-control-sm" 
                                      placeholder="Adicione suas observações..." 
                                      rows="2" 
                                      id="notes_${leadData.id}"
                                      onchange="saveLeadNotes(${leadData.id}, this.value)"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="badge bg-info">Novo</span>
                            <small class="text-muted">ID: ${leadData.id}</small>
                        </div>
                    </div>
                </div>
            `;
            
            return cardDiv;
        }

        // Função para salvar observações do lead
        function saveLeadNotes(leadId, notes) {
            // Salvar no localStorage por enquanto
            localStorage.setItem(`lead_notes_${leadId}`, notes);
            
            if (typeof showToast === 'function') {
                showToast('CRM', 'Observação salva!', 'success');
            }
        }

        // Função para carregar dados da empresa
        async function loadCompanyLeads(companyName) {
            try {
                console.log(`[CRM Frontend] Carregando leads para empresa: "${companyName}"`);
                
                // Fazer requisição para buscar os dados da tabela da empresa
                const url = `/api/crm/leads/${encodeURIComponent(companyName)}`;
                console.log(`[CRM Frontend] URL da requisição: ${url}`);
                
                const response = await fetch(url);
                
                console.log(`[CRM Frontend] Status da resposta: ${response.status}`);
                console.log(`[CRM Frontend] Response OK: ${response.ok}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[CRM Frontend] Erro na resposta:`, errorText);
                    throw new Error(`Erro ao carregar leads: ${response.status} - ${errorText}`);
                }
                
                const leads = await response.json();
                console.log(`[CRM Frontend] ✅ Recebidos ${leads.length} leads para "${companyName}"`);
                console.log(`[CRM Frontend] Dados recebidos:`, leads);
                
                // Limpar todas as colunas
                document.querySelectorAll('.crm-column-body').forEach(column => {
                    column.innerHTML = '';
                });
                
                // Adicionar leads na primeira coluna (Entrou!)
                const firstColumn = document.querySelector('[data-stage="entrou"] .crm-column-body');
                
                if (leads.length === 0) {
                    firstColumn.innerHTML = '<p class="text-muted text-center">Nenhum lead encontrado para esta empresa.</p>';
                    console.log(`[CRM Frontend] ⚠️ Nenhum lead encontrado para "${companyName}"`);
                    return;
                }
                
                leads.forEach((lead, index) => {
                    console.log(`[CRM Frontend] Processando lead ${index + 1}:`, {
                        id: lead.id,
                        nome: lead.nome,
                        email: lead.email,
                        data_entrada: lead.data_hora_entrada
                    });
                    
                    const leadCard = createLeadCardFromDB(lead);
                    
                    // Carregar observações salvas
                    const savedNotes = localStorage.getItem(`lead_notes_${lead.id}`);
                    if (savedNotes) {
                        setTimeout(() => {
                            const notesTextarea = leadCard.querySelector(`#notes_${lead.id}`);
                            if (notesTextarea) {
                                notesTextarea.value = savedNotes;
                            }
                        }, 100);
                    }
                    
                    firstColumn.appendChild(leadCard);
                });
                
                console.log(`[CRM Frontend] ✅ Todos os ${leads.length} leads foram adicionados ao DOM`);
                
            } catch (error) {
                console.error('[CRM Frontend] Erro ao carregar leads:', error);
                
                // Mostrar mensagem de erro
                const firstColumn = document.querySelector('[data-stage="entrou"] .crm-column-body');
                firstColumn.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Não foi possível carregar os leads desta empresa.
                        <br><small>Erro: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Função para controlar visibilidade do CRM
        function toggleCRMVisibility() {
            const crmSection = document.getElementById('crmSection');
            const companySelect = document.getElementById('company-select');
            
            console.log(`[CRM Visibility] Verificando visibilidade...`);
            
            if (!crmSection || !companySelect) {
                console.log(`[CRM Visibility] ❌ Elementos não encontrados - crmSection: ${!!crmSection}, companySelect: ${!!companySelect}`);
                return;
            }
            
            const selectedCompany = companySelect.value;
            const selectedCompanyText = companySelect.options[companySelect.selectedIndex]?.text;
            const totalOptions = companySelect.options.length;
            
            console.log(`[CRM Visibility] Estado atual:`);
            console.log(`  - Empresa selecionada (value): "${selectedCompany}"`);
            console.log(`  - Empresa selecionada (text): "${selectedCompanyText}"`);
            console.log(`  - Total de opções: ${totalOptions}`);
            console.log(`  - Todas as opções:`, Array.from(companySelect.options).map(opt => `"${opt.text}" (value: "${opt.value}")`));
            
            // Mostra CRM se:
            // 1. Uma empresa específica está selecionada (não vazio e não "Todas as Empresas")
            // 2. OU se o usuário tem acesso a apenas uma empresa (2 opções: "Todas as Empresas" + 1 empresa)
            if (selectedCompany && selectedCompany !== '' && selectedCompany !== 'Todas as Empresas') {
                // Empresa específica selecionada
                console.log(`[CRM Visibility] ✅ Empresa específica selecionada: "${selectedCompanyText}"`);
                crmSection.classList.remove('d-none');
                
                // Carregar leads da empresa selecionada
                if (selectedCompanyText && selectedCompanyText !== 'Todas as Empresas') {
                    console.log(`[CRM Visibility] 🔄 Carregando leads para: "${selectedCompanyText}"`);
                    loadCompanyLeads(selectedCompanyText);
                }
            } else if (totalOptions === 2 && companySelect.options[1]) {
                // Usuário tem acesso a apenas uma empresa
                const singleCompanyText = companySelect.options[1].text;
                console.log(`[CRM Visibility] ✅ Usuário com acesso a apenas uma empresa: "${singleCompanyText}"`);
                crmSection.classList.remove('d-none');
                
                // Carregar leads da única empresa disponível
                console.log(`[CRM Visibility] 🔄 Carregando leads para única empresa: "${singleCompanyText}"`);
                loadCompanyLeads(singleCompanyText);
            } else {
                // Ocultar CRM
                console.log(`[CRM Visibility] ❌ Ocultando CRM - nenhuma empresa específica selecionada`);
                crmSection.classList.add('d-none');
            }
        }

        // Monitora mudanças no select de empresa
        document.addEventListener('DOMContentLoaded', function() {
            const companySelect = document.getElementById('company-select');
            if (companySelect) {
                // Verifica visibilidade inicial
                setTimeout(toggleCRMVisibility, 500); // Aguarda carregamento das empresas
                
                // Monitora mudanças no select
                companySelect.addEventListener('change', toggleCRMVisibility);
                
                // Verifica periodicamente se as empresas foram carregadas
                const checkInterval = setInterval(function() {
                    if (companySelect.options.length > 1) {
                        toggleCRMVisibility();
                        clearInterval(checkInterval);
                    }
                }, 100);
            }
        });
    </script>

<!-- JavaScript Bundle -->    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/company-management.js"></script>
    <script src="js/filters.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/app.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/app.js"></script>
    <script src="js/remove-top-summaries.js"></script>
</body>
</html>
